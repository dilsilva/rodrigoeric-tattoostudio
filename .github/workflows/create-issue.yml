name: Create Issue from Contact Form

on:
  repository_dispatch:
    types: [contact-form-submission]

jobs:
  create-issue:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    steps:
      - name: Create GitHub Issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Get the payload from the repository_dispatch event
            const payload = github.context.payload.client_payload;
            
            if (!payload) {
              throw new Error('No payload received from repository_dispatch');
            }
            
            const { name, email, message } = payload;
            
            if (!name || !email || !message) {
              throw new Error('Missing required fields in payload');
            }
            
            const issueTitle = `New Tattoo Inquiry from ${name}`;
            const issueBody = `## Contact Information
**Name:** ${name}
**Email:** ${email}

## Tattoo Idea
${message}

---
*Submitted via website contact form*`;

            try {
              const { data } = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: issueBody,
                labels: ['inquiry', 'contact-form'] // Will fail silently if labels don't exist
              });

              console.log(`✅ Created issue #${data.number}: ${data.html_url}`);
            } catch (error) {
              // Try again without labels if they don't exist
              if (error.status === 422 && error.message.includes('label')) {
                console.log('⚠️ Labels not found, creating issue without labels...');
                const { data } = await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: issueTitle,
                  body: issueBody
                });
                console.log(`✅ Created issue #${data.number} (without labels): ${data.html_url}`);
              } else {
                throw error;
              }
            }
