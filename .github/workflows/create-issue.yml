name: Create Issue from Contact Form

on:
  repository_dispatch:
    types: [contact-form-submission]

jobs:
  create-issue:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    steps:
      - name: Create GitHub Issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Get the payload from the repository_dispatch event
            const payload = github.context.payload.client_payload;
            
            if (!payload) {
              throw new Error('No payload received from repository_dispatch');
            }
            
            const { name, email, message } = payload;
            
            if (!name || !email || !message) {
              throw new Error('Missing required fields in payload');
            }
            
            // Sanitize inputs to prevent injection
            const sanitize = (str) => String(str || '').replace(/[<>]/g, '').trim();
            const sanitizedName = sanitize(name);
            const sanitizedEmail = sanitize(email);
            const sanitizedMessage = sanitize(message);
            
            // Validate lengths
            if (sanitizedName.length === 0 || sanitizedName.length > 100) {
              throw new Error('Invalid name length');
            }
            if (sanitizedEmail.length === 0 || sanitizedEmail.length > 255) {
              throw new Error('Invalid email length');
            }
            if (sanitizedMessage.length < 10 || sanitizedMessage.length > 5000) {
              throw new Error('Invalid message length');
            }
            
            const issueTitle = `New Tattoo Inquiry from ${sanitizedName}`;
            // Limit title to GitHub's 255 char limit
            const truncatedTitle = issueTitle.length > 255 ? issueTitle.substring(0, 252) + '...' : issueTitle;
            
            const issueBody = `## Contact Information
**Name:** ${sanitizedName}
**Email:** ${sanitizedEmail}

## Tattoo Idea
${sanitizedMessage}

---
*Submitted via website contact form on ${new Date().toISOString()}*`;

            try {
              const { data } = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: truncatedTitle,
                body: issueBody,
                labels: ['inquiry', 'contact-form'] // Will fail silently if labels don't exist
              });

              console.log(`✅ Created issue #${data.number}: ${data.html_url}`);
            } catch (error) {
              // Try again without labels if they don't exist
              if (error.status === 422 && error.message.includes('label')) {
                console.log('⚠️ Labels not found, creating issue without labels...');
                const { data } = await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: truncatedTitle,
                  body: issueBody
                });
                console.log(`✅ Created issue #${data.number} (without labels): ${data.html_url}`);
              } else {
                throw error;
              }
            }
